<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dois Corpos - Planejador de Casamento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Lato:wght@300;400;700&display=swap');

        /* --- THEME --- */
        :root {
            --color-emerald-dark: #064E3B;
            --color-emerald-main: #10B981;
            --color-gold: #D4AF37;
            --color-bg: #F9FAFB;
        }

        body { font-family: 'Lato', sans-serif; background-color: var(--color-bg); color: #374151; }
        h1, h2, h3, h4, .serif-font { font-family: 'Playfair Display', serif; }
        .decorative-font { font-family: 'Cinzel', serif; }

        /* --- ANIMATIONS --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }

        /* --- COMPONENTS --- */
        .btn-primary {
            background: linear-gradient(135deg, #065f46 0%, #047857 100%);
            color: white; transition: all 0.3s ease; box-shadow: 0 4px 6px -1px rgba(6, 78, 59, 0.3);
        }
        .btn-primary:hover {
            transform: translateY(-1px); box-shadow: 0 6px 8px -1px rgba(6, 78, 59, 0.4);
        }
        
        .nav-item { position: relative; color: #6B7280; transition: color 0.3s; }
        .nav-item.active { color: #065f46; font-weight: 700; }
        .nav-item.active::after {
            content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 2px; background-color: var(--color-gold);
        }

        .card { 
            background-color: white; border: 1px solid #E5E7EB; border-radius: 12px; 
            box-shadow: 0 2px 4px -1px rgba(0,0,0,0.02); transition: transform 0.2s, box-shadow 0.2s; 
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); border-color: #D1D5DB; }

        .input-elegant { 
            border: 1px solid #E5E7EB; border-radius: 8px; padding: 0.6rem; background-color: #F9FAFB; transition: all 0.2s;
        }
        .input-elegant:focus { 
            outline: none; border-color: var(--color-gold); background-color: white; box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1); 
        }

        .tag-pill { @apply text-[10px] px-2 py-1 rounded-full border border-stone-200 cursor-pointer select-none transition bg-white text-stone-600 uppercase tracking-wider; }
        .tag-pill.selected { background-color: #ECFDF5; border-color: #10B981; color: #065F46; font-weight: bold; }

        /* --- MODAL --- */
        #edit-modal { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        #login-overlay { background-color: #F0FDFA; background-image: radial-gradient(#E0E7FF 1px, transparent 1px); background-size: 20px 20px; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- LOGIN SCREEN -->
    <div id="login-overlay" class="fixed inset-0 z-[100] flex flex-col items-center justify-center p-4 transition-opacity duration-500">
        <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-2xl text-center border-t-4 border-emerald-800 relative">
            <div class="mb-6">
                <canvas id="logo-login" width="100" height="70" class="mx-auto mb-4"></canvas>
                <h1 class="text-3xl decorative-font text-emerald-900 mb-1">Dois Corpos</h1>
                <div class="h-0.5 w-12 bg-yellow-400 mx-auto mb-2"></div>
                <p class="text-stone-500 text-xs uppercase tracking-widest">Gest√£o de Casamento</p>
            </div>
            
            <div id="auth-form" class="space-y-4 text-left">
                <input type="email" id="email" class="input-elegant w-full" placeholder="Email">
                <input type="password" id="password" class="input-elegant w-full" placeholder="Senha">
                <p id="auth-error" class="text-red-500 text-xs h-4 text-center font-bold"></p>
                <button onclick="handleAuth()" id="btn-auth" class="btn-primary w-full py-2.5 rounded-lg font-bold text-sm uppercase tracking-wide">Entrar</button>
                <div class="text-center mt-4 pt-3 border-t border-stone-100">
                    <button onclick="toggleAuthMode()" class="text-xs font-bold text-emerald-700 hover:text-emerald-900 underline" id="toggle-btn">Criar conta nova</button>
                </div>
            </div>
            <div id="auth-loading" class="hidden py-6"><p class="text-emerald-800 text-sm animate-pulse">Conectando...</p></div>
        </div>
    </div>

    <!-- EDIT MODAL -->
    <div id="edit-modal" class="fixed inset-0 z-[90] hidden flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-lg border-t-4 border-emerald-600 animate-fade-in">
            <h3 class="text-xl font-serif text-emerald-900 mb-4">Editar Item</h3>
            <div id="modal-content" class="space-y-4"></div> <!-- Dynamic Content -->
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="closeModal()" class="px-4 py-2 text-sm text-stone-500 hover:bg-stone-100 rounded">Cancelar</button>
                <button id="modal-save-btn" class="btn-primary px-6 py-2 rounded text-sm font-bold">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <!-- APP HEADER -->
    <header class="bg-white border-b border-stone-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-3">
                    <canvas id="logo-header" width="40" height="30"></canvas>
                    <div>
                        <span class="text-lg text-emerald-900 font-bold decorative-font block leading-none">Dois Corpos</span>
                        <span id="connection-status" class="text-[9px] uppercase font-bold text-stone-400">Offline</span>
                    </div>
                </div>
                <nav class="hidden md:flex space-x-6">
                    <button onclick="switchTab('dashboard')" class="nav-item active text-xs uppercase font-bold tracking-widest py-2">Vis√£o Geral</button>
                    <button onclick="switchTab('budget')" class="nav-item text-xs uppercase font-bold tracking-widest py-2">Or√ßamento</button>
                    <button onclick="switchTab('guests')" class="nav-item text-xs uppercase font-bold tracking-widest py-2">Convidados</button>
                    <button onclick="switchTab('timeline')" class="nav-item text-xs uppercase font-bold tracking-widest py-2">Tarefas</button>
                </nav>
                <button onclick="handleLogout()" class="text-xs text-stone-400 hover:text-red-500">Sair</button>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-grow max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- DASHBOARD -->
        <section id="dashboard" class="space-y-8 animate-fade-in">
            <div class="text-center">
                <h2 class="text-3xl text-emerald-900 serif-font italic">Painel do Casal</h2>
            </div>

            <!-- Global Settings (Date & Budget) -->
            <div class="flex justify-center">
                 <div class="bg-white p-2 rounded-lg shadow border border-stone-100 flex flex-col sm:flex-row items-center gap-2">
                     <div class="flex items-center gap-2 px-2">
                         <span class="text-xs font-bold text-emerald-800 uppercase">Data:</span>
                         <input type="date" id="wedding-date-input" class="bg-stone-50 border border-stone-200 rounded p-1 text-sm text-stone-700 focus:outline-none focus:border-emerald-500">
                     </div>
                     <div class="flex items-center gap-2 px-2 border-l border-stone-100">
                         <span class="text-xs font-bold text-emerald-800 uppercase">Or√ßamento Total R$:</span>
                         <input type="number" id="total-budget-input" class="bg-stone-50 border border-stone-200 rounded p-1 w-28 text-sm text-stone-700 focus:outline-none focus:border-emerald-500">
                     </div>
                     <button onclick="saveGlobalSettings()" class="bg-emerald-800 text-white text-xs font-bold px-4 py-1.5 rounded hover:bg-emerald-700 transition ml-2">
                         Salvar
                     </button>
                 </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Count -->
                <div class="card p-6 border-t-4 border-rose-300">
                    <h3 class="text-xs font-bold text-stone-400 uppercase tracking-widest">Contagem Regressiva</h3>
                    <div class="mt-2 flex items-baseline">
                        <span class="text-4xl serif-font text-emerald-900 mr-2" id="days-count">--</span>
                        <span class="text-stone-500 italic text-sm">dias</span>
                    </div>
                </div>
                <!-- Budget -->
                <div class="card p-6 border-t-4 border-emerald-400">
                    <h3 class="text-xs font-bold text-stone-400 uppercase tracking-widest">Or√ßamento Gasto</h3>
                    <div class="mt-2 flex items-baseline justify-between">
                        <span class="text-3xl serif-font text-emerald-700" id="dash-budget-percent">0%</span>
                        <span class="text-stone-500 text-xs" id="dash-budget-left">Dispon√≠vel: R$ 0</span>
                    </div>
                    <div class="w-full bg-stone-100 h-1.5 mt-2 rounded-full overflow-hidden">
                        <div id="dash-progress-bar" class="bg-emerald-500 h-full w-0 transition-all duration-1000"></div>
                    </div>
                </div>
                <!-- Guests -->
                <div class="card p-6 border-t-4 border-blue-300">
                    <h3 class="text-xs font-bold text-stone-400 uppercase tracking-widest">Resumo Convidados</h3>
                    <div class="mt-2 flex flex-col space-y-2">
                        <div class="flex items-baseline justify-between">
                            <div>
                                <span class="text-4xl serif-font text-blue-900 mr-2" id="dash-total-pax">0</span>
                                <span class="text-stone-500 text-sm">pessoas (total)</span>
                            </div>
                            <div class="text-right">
                                <span class="text-xl font-bold text-green-600 block leading-none" id="dash-guest-confirmed">0</span>
                                <span class="text-[10px] text-stone-400 uppercase">Confirmados</span>
                            </div>
                        </div>
                        <div class="flex items-baseline pt-2 border-t border-stone-100">
                            <span class="text-lg font-bold text-stone-600 mr-2" id="dash-invites-count">0</span>
                            <span class="text-stone-400 text-xs uppercase">Convites (Fam√≠lias/Grupos)</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- BUDGET -->
        <section id="budget" class="hidden space-y-6 animate-fade-in">
            <h2 class="text-2xl font-serif text-emerald-900 border-b border-stone-200 pb-2">Controle Financeiro</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- List & Add -->
                <div class="lg:col-span-2 space-y-4">
                    <div class="card p-4 bg-emerald-50 border-emerald-100">
                        <h4 class="text-xs font-bold text-emerald-800 uppercase mb-2">Novo Gasto</h4>
                        <div class="flex gap-2">
                            <select id="new-exp-cat" class="input-elegant text-xs w-1/3">
                                <option value="" disabled selected>Categoria</option>
                                <option>Buffet & Comida</option><option>Local</option><option>Foto & V√≠deo</option>
                                <option>Decora√ß√£o</option><option>M√∫sica/DJ</option><option>Vestido/Beleza</option>
                                <option>Doces/Bolo</option><option>Assessoria</option><option>Outros</option>
                            </select>
                            <input type="number" id="new-exp-val" placeholder="Valor R$" class="input-elegant text-xs flex-grow">
                            <button onclick="addExpense()" class="bg-emerald-600 text-white px-4 rounded text-xs font-bold hover:bg-emerald-700">Adicionar</button>
                        </div>
                    </div>

                    <div class="card overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-stone-50 text-xs font-bold text-stone-500 uppercase">
                                <tr>
                                    <th class="p-3">Item</th>
                                    <th class="p-3 text-right">Valor</th>
                                    <th class="p-3 text-center">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="budget-list-body" class="text-sm divide-y divide-stone-100"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Analysis -->
                <div class="space-y-4">
                    <div class="card p-6 text-center">
                        <div class="chart-container h-40"><canvas id="budgetChart"></canvas></div>
                        <p class="mt-4 text-xs font-bold text-stone-400 uppercase">Saldo Dispon√≠vel</p>
                        <p class="text-xl font-serif text-emerald-600 font-bold" id="budget-balance-display">R$ 0</p>
                    </div>
                    <div id="savings-tips" class="card p-4 bg-yellow-50 border-yellow-200 text-xs text-stone-700 space-y-2"></div>
                </div>
            </div>
        </section>

        <!-- GUESTS -->
        <section id="guests" class="hidden space-y-6 animate-fade-in">
            <h2 class="text-2xl font-serif text-emerald-900 border-b border-stone-200 pb-2">Convidados</h2>
            
            <div class="card p-4 bg-white shadow-sm border border-emerald-100">
                <div class="grid grid-cols-12 gap-3 items-end">
                    <div class="col-span-12 sm:col-span-5">
                        <label class="text-[10px] font-bold text-stone-400 uppercase">Nome Principal (Convite)</label>
                        <input type="text" id="new-guest-name" class="input-elegant w-full text-sm">
                    </div>
                    <div class="col-span-6 sm:col-span-2">
                        <label class="text-[10px] font-bold text-stone-400 uppercase">+ Acompanhantes</label>
                        <input type="number" id="new-guest-partners" value="0" min="0" class="input-elegant w-full text-sm">
                    </div>
                    <div class="col-span-6 sm:col-span-5">
                        <label class="text-[10px] font-bold text-stone-400 uppercase mb-1 block">Tags (Clique para marcar)</label>
                        <div class="flex flex-wrap gap-1" id="guest-tags-selector">
                            <span onclick="toggleTag(this)" class="tag-pill">Padrinho</span>
                            <span onclick="toggleTag(this)" class="tag-pill">Madrinha</span>
                            <span onclick="toggleTag(this)" class="tag-pill">Fam√≠lia</span>
                            <span onclick="toggleTag(this)" class="tag-pill">Amigos</span>
                            <span onclick="toggleTag(this)" class="tag-pill">Fornecedor</span>
                            <span onclick="toggleTag(this)" class="tag-pill">Deu Presente</span>
                        </div>
                    </div>
                    <div class="col-span-12 mt-2">
                        <button onclick="addGuest()" class="btn-primary w-full py-2 rounded text-sm font-bold">Salvar Convidado</button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1 card p-4 h-fit">
                    <h4 class="font-bold text-emerald-800 text-sm mb-3">Estat√≠sticas</h4>
                    <div class="space-y-3 text-sm text-stone-600">
                        <div class="flex justify-between border-b border-stone-100 pb-1">
                            <span>Convites (Grupos):</span> 
                            <b id="stats-invites">0</b>
                        </div>
                        <div class="flex justify-between border-b border-stone-100 pb-1">
                            <span>Total de Pessoas:</span> 
                            <b id="stats-total-pax" class="text-blue-800 text-lg">0</b>
                        </div>
                        <div class="flex justify-between text-green-600 pt-1">
                            <span>Confirmados:</span> 
                            <b id="stats-confirmed">0</b>
                        </div>
                    </div>
                    <div class="mt-4 h-32"><canvas id="guestChart"></canvas></div>
                </div>
                <div class="md:col-span-2 card overflow-hidden">
                    <div class="overflow-y-auto max-h-[500px] custom-scroll">
                        <table class="w-full text-left">
                            <thead class="bg-stone-50 sticky top-0 text-xs font-bold text-stone-500 uppercase">
                                <tr>
                                    <th class="p-3">Nome</th>
                                    <th class="p-3">Pax Total</th>
                                    <th class="p-3">Tags</th>
                                    <th class="p-3">Status</th>
                                    <th class="p-3 text-right"></th>
                                </tr>
                            </thead>
                            <tbody id="guest-list-body" class="text-sm divide-y divide-stone-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- TASKS -->
        <section id="timeline" class="hidden space-y-6 animate-fade-in">
            <h2 class="text-2xl font-serif text-emerald-900 border-b border-stone-200 pb-2">Tarefas</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 h-fit sticky top-24">
                    <div class="card p-4 bg-stone-50">
                        <h4 class="text-xs font-bold text-stone-500 uppercase mb-3">Nova Tarefa</h4>
                        <input type="text" id="new-task-input" placeholder="T√≠tulo..." class="input-elegant w-full mb-2 text-sm">
                        <select id="new-task-cat" class="input-elegant w-full mb-2 text-sm">
                            <option value="Geral">Geral</option><option value="Cerim√¥nia">Cerim√¥nia</option>
                            <option value="Festa">Festa</option><option value="Roupa">Roupa</option>
                        </select>
                        <input type="date" id="new-task-date" class="input-elegant w-full mb-2 text-sm">
                        <button onclick="addTask()" class="bg-stone-700 text-white w-full py-2 rounded text-sm font-bold hover:bg-stone-800">Adicionar</button>
                    </div>
                </div>
                <div class="lg:col-span-2 card p-4">
                    <div id="tasks-list" class="space-y-2"></div>
                </div>
            </div>
        </section>

        <!-- TOOLS -->
        <section id="tools" class="hidden space-y-6 animate-fade-in">
            <h2 class="text-2xl font-serif text-emerald-900">Calculadora</h2>
            <div class="card p-6 border-t-4 border-yellow-400">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-4">
                        <input type="number" id="calc-guests" value="100" class="input-elegant w-full" oninput="calculateDrinks()" placeholder="Qtd. Convidados">
                        <select id="calc-profile" class="input-elegant w-full" onchange="calculateDrinks()">
                            <option value="moderate">Cerveja + Refri</option>
                            <option value="high">Cerveja + Destilados</option>
                            <option value="low">Brunch/Leve</option>
                        </select>
                    </div>
                    <div class="md:col-span-2 grid grid-cols-2 gap-4 text-center">
                        <div class="p-3 bg-stone-50 rounded border"><span class="text-2xl font-bold block" id="res-beer">0</span><span class="text-[10px] uppercase">Latas Cerveja</span></div>
                        <div class="p-3 bg-stone-50 rounded border"><span class="text-2xl font-bold block" id="res-water">0</span><span class="text-[10px] uppercase">√Ågua</span></div>
                        <div class="p-3 bg-stone-50 rounded border"><span class="text-2xl font-bold block" id="res-soda">0</span><span class="text-[10px] uppercase">Refri 2L</span></div>
                        <div class="p-3 bg-stone-50 rounded border"><span class="text-2xl font-bold block" id="res-sparkling">0</span><span class="text-[10px] uppercase">Espumante</span></div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, updateDoc, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- VISUALS ---
        function drawLogo(id) {
            const canvas = document.getElementById(id);
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.width, h = canvas.height;
            ctx.clearRect(0,0,w,h);
            ctx.lineWidth = 2.5; ctx.strokeStyle = '#D4AF37'; // Gold
            ctx.beginPath(); ctx.arc(w/2 - 8, h/2, 12, 0, Math.PI*2); ctx.stroke();
            ctx.beginPath(); ctx.arc(w/2 + 8, h/2, 12, 0, Math.PI*2); ctx.stroke();
        }
        window.addEventListener('load', () => { drawLogo('logo-login'); drawLogo('logo-header'); });

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBbd5GSe2dAOuDPFy3K3h6r53Op9y1iFbw",
            authDomain: "doiscorpos-2f241.firebaseapp.com",
            projectId: "doiscorpos-2f241",
            storageBucket: "doiscorpos-2f241.firebasestorage.app",
            messagingSenderId: "924599762554",
            appId: "1:924599762554:web:5a61ad6d21580a74a105c3"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let isRegistering = false;
        
        // --- HELPER FOR DB PATH ---
        const getAppId = () => typeof __app_id !== 'undefined' ? __app_id : 'doiscorpos-default';
        const getUserRoot = () => currentUser ? `artifacts/${getAppId()}/users/${currentUser.uid}` : null;

        // --- AUTH LOGIC ---
        window.toggleAuthMode = () => {
            isRegistering = !isRegistering;
            document.getElementById('btn-auth').innerText = isRegistering ? "Cadastrar & Entrar" : "Entrar";
            document.getElementById('toggle-btn').innerText = isRegistering ? "J√° tenho conta" : "Criar conta nova";
        };

        window.handleAuth = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const err = document.getElementById('auth-error');
            const btn = document.getElementById('btn-auth');
            
            if(!email || !pass) { err.innerText = "Preencha tudo."; return; }
            btn.disabled = true; btn.innerText = "Processando...";

            try {
                if(isRegistering) await createUserWithEmailAndPassword(auth, email, pass);
                else await signInWithEmailAndPassword(auth, email, pass);
            } catch(e) {
                console.error(e);
                let msg = "Erro desconhecido.";
                if(e.code.includes('password')) msg = "Senha errada/fraca.";
                if(e.code.includes('user-not-found')) msg = "Usu√°rio n√£o existe.";
                if(e.code.includes('email-already-in-use')) msg = "Email j√° usado.";
                err.innerText = msg;
                btn.disabled = false; btn.innerText = isRegistering ? "Cadastrar" : "Entrar";
            }
        };

        window.handleLogout = async () => { await signOut(auth); location.reload(); };

        // AUTO LOGIN (Env Token)
        const init = async () => {
            if(typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                    if(typeof __firebase_config !== 'undefined' && JSON.parse(__firebase_config).projectId === firebaseConfig.projectId) {
                        document.getElementById('auth-form').classList.add('hidden');
                        document.getElementById('auth-loading').classList.remove('hidden');
                        await signInWithCustomToken(auth, __initial_auth_token);
                    }
                } catch(e) { console.warn("Auto-login fallback"); }
            }
        };
        init();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-overlay').classList.add('opacity-0', 'pointer-events-none');
                document.getElementById('connection-status').innerText = "ONLINE";
                document.getElementById('connection-status').className = "text-[9px] uppercase font-bold text-green-600";
                setupListeners();
            } else {
                document.getElementById('login-overlay').classList.remove('opacity-0', 'pointer-events-none');
                document.getElementById('auth-form').classList.remove('hidden');
                document.getElementById('auth-loading').classList.add('hidden');
            }
        });

        // --- FIRESTORE HANDLING ---
        const handleDbError = (err) => {
            console.error("DB Error:", err);
            if(err.code === 'permission-denied') {
                alert("ERRO DE PERMISS√ÉO!\n\nO Firebase bloqueou a escrita. V√° ao Console > Firestore > Rules e mude para:\nallow read, write: if request.auth != null;");
            } else {
                alert("Erro ao salvar: " + err.message);
            }
        };

        let state = { budget: [], guests: [], tasks: [] };

        function setupListeners() {
            const root = getUserRoot();
            if(!root) return;

            // Settings
            onSnapshot(doc(db, root, 'settings', 'general'), (snap) => {
                if(snap.exists()) {
                    const d = snap.data();
                    document.getElementById('wedding-date-input').value = d.date || '';
                    document.getElementById('total-budget-input').value = d.budgetTotal || '';
                    updateUI(d);
                }
            }, (err) => console.warn("Read settings error", err));

            onSnapshot(collection(db, root, 'expenses'), s => {
                state.budget = []; s.forEach(d => state.budget.push({id: d.id, ...d.data()})); updateUI();
            });
            onSnapshot(collection(db, root, 'guests'), s => {
                state.guests = []; s.forEach(d => state.guests.push({id: d.id, ...d.data()})); updateUI();
            });
            onSnapshot(collection(db, root, 'tasks'), s => {
                state.tasks = []; s.forEach(d => state.tasks.push({id: d.id, ...d.data()})); updateUI();
            });
        }

        // --- CRUD OPERATIONS ---

        window.saveGlobalSettings = async () => {
            if(!getUserRoot()) return;
            const date = document.getElementById('wedding-date-input').value;
            const budgetTotal = parseFloat(document.getElementById('total-budget-input').value) || 0;
            try {
                await setDoc(doc(db, getUserRoot(), 'settings', 'general'), { date, budgetTotal }, { merge: true });
                alert("Configura√ß√µes salvas com sucesso!");
            } catch(e) { handleDbError(e); }
        };

        // Generic Helpers
        async function addItem(coll, data) {
            try { await addDoc(collection(db, getUserRoot(), coll), { ...data, timestamp: serverTimestamp() }); } catch(e) { handleDbError(e); }
        }
        async function updateItem(coll, id, data) {
            try { await updateDoc(doc(db, getUserRoot(), coll, id), data); } catch(e) { handleDbError(e); }
        }
        async function deleteItem(coll, id) {
            if(!confirm("Excluir item?")) return;
            try { await deleteDoc(doc(db, getUserRoot(), coll, id)); } catch(e) { handleDbError(e); }
        }

        // Wrappers
        window.addExpense = () => {
            const cat = document.getElementById('new-exp-cat').value;
            const val = parseFloat(document.getElementById('new-exp-val').value);
            if(cat && val) { addItem('expenses', { category: cat, amount: val }); document.getElementById('new-exp-val').value = ''; }
        };
        window.deleteExpense = (id) => deleteItem('expenses', id);

        window.addGuest = () => {
            const name = document.getElementById('new-guest-name').value;
            const partners = parseInt(document.getElementById('new-guest-partners').value) || 0;
            const tags = [];
            document.querySelectorAll('#guest-tags-selector .tag-pill.selected').forEach(el => tags.push(el.innerText));
            if(name) {
                addItem('guests', { name, partners, tags, status: 'pending' });
                document.getElementById('new-guest-name').value = '';
                document.querySelectorAll('.tag-pill.selected').forEach(el => el.classList.remove('selected'));
            }
        };
        window.deleteGuest = (id) => deleteItem('guests', id);
        window.toggleTag = (el) => el.classList.toggle('selected');
        window.updateGuestStatus = (id, val) => updateItem('guests', id, { status: val });

        window.addTask = () => {
            const text = document.getElementById('new-task-input').value;
            const cat = document.getElementById('new-task-cat').value;
            const date = document.getElementById('new-task-date').value;
            if(text) {
                addItem('tasks', { text, category: cat, deadline: date, done: false });
                document.getElementById('new-task-input').value = '';
            }
        };
        window.toggleTask = (id, current) => updateItem('tasks', id, { done: !current });
        window.deleteTask = (id) => deleteItem('tasks', id);

        // --- EDITING FEATURES (MODAL) ---
        let currentEditInfo = null; 

        window.openEditModal = (coll, id) => {
            const modal = document.getElementById('edit-modal');
            const content = document.getElementById('modal-content');
            currentEditInfo = { coll, id };
            content.innerHTML = ''; 

            let item;
            if(coll === 'expenses') item = state.budget.find(x => x.id === id);
            if(coll === 'guests') item = state.guests.find(x => x.id === id);
            if(coll === 'tasks') item = state.tasks.find(x => x.id === id);

            if(!item) return;

            // Forms
            if(coll === 'expenses') {
                content.innerHTML = `
                    <label class="text-xs font-bold text-stone-500">Valor</label>
                    <input id="edit-val" type="number" class="input-elegant w-full mb-3" value="${item.amount}">
                    <label class="text-xs font-bold text-stone-500">Categoria</label>
                    <select id="edit-cat" class="input-elegant w-full">
                        <option value="${item.category}" selected>${item.category}</option>
                        <option>Buffet & Comida</option><option>Local</option><option>Foto & V√≠deo</option>
                        <option>Decora√ß√£o</option><option>M√∫sica/DJ</option><option>Outros</option>
                    </select>
                `;
            } else if(coll === 'guests') {
                const currentTags = item.tags || [];
                const allTags = ['Padrinho','Madrinha','Fam√≠lia','Amigos','Fornecedor','Deu Presente'];
                
                let tagsHtml = `<div class="flex flex-wrap gap-2 mt-2" id="edit-guest-tags">`;
                allTags.forEach(t => {
                    const isSel = currentTags.includes(t) ? 'selected' : '';
                    tagsHtml += `<span onclick="toggleTag(this)" class="tag-pill ${isSel}">${t}</span>`;
                });
                tagsHtml += `</div>`;

                content.innerHTML = `
                    <label class="text-xs font-bold text-stone-500">Nome</label>
                    <input id="edit-name" type="text" class="input-elegant w-full mb-3" value="${item.name}">
                    <label class="text-xs font-bold text-stone-500">Acompanhantes</label>
                    <input id="edit-partners" type="number" class="input-elegant w-full mb-3" value="${item.partners}">
                    <label class="text-xs font-bold text-stone-500">Tags</label>
                    ${tagsHtml}
                `;
            } else if(coll === 'tasks') {
                content.innerHTML = `
                    <label class="text-xs font-bold text-stone-500">Descri√ß√£o</label>
                    <input id="edit-text" type="text" class="input-elegant w-full mb-3" value="${item.text}">
                    <label class="text-xs font-bold text-stone-500">Data Limite</label>
                    <input id="edit-date" type="date" class="input-elegant w-full" value="${item.deadline}">
                `;
            }

            modal.classList.remove('hidden');
        };

        window.closeModal = () => { document.getElementById('edit-modal').classList.add('hidden'); currentEditInfo = null; };

        document.getElementById('modal-save-btn').onclick = async () => {
            if(!currentEditInfo) return;
            const { coll, id } = currentEditInfo;
            let data = {};

            if(coll === 'expenses') {
                data.amount = parseFloat(document.getElementById('edit-val').value);
                data.category = document.getElementById('edit-cat').value;
            } else if(coll === 'guests') {
                data.name = document.getElementById('edit-name').value;
                data.partners = parseInt(document.getElementById('edit-partners').value);
                // Collect tags from modal
                const tags = [];
                document.querySelectorAll('#edit-guest-tags .tag-pill.selected').forEach(el => tags.push(el.innerText));
                data.tags = tags;
            } else if(coll === 'tasks') {
                data.text = document.getElementById('edit-text').value;
                data.deadline = document.getElementById('edit-date').value;
            }

            await updateItem(coll, id, data);
            closeModal();
        };


        // --- UI UPDATERS ---
        function updateUI(settings) {
            if(!settings) {
                const d = document.getElementById('wedding-date-input').value;
                const b = parseFloat(document.getElementById('total-budget-input').value) || 0;
                settings = { date: d, budgetTotal: b };
            }

            // Dashboard Stats
            if(settings.date) {
                const diff = Math.ceil((new Date(settings.date) - new Date())/(1000*60*60*24));
                const daysEl = document.getElementById('days-count');
                if (daysEl) daysEl.innerText = diff > 0 ? diff : 0;
            }
            const spent = state.budget.reduce((a,b) => a + b.amount, 0);
            const total = settings.budgetTotal || 0;
            const pct = total > 0 ? Math.min(100, Math.round((spent/total)*100)) : 0;
            
            const pctEl = document.getElementById('dash-budget-percent');
            if(pctEl) pctEl.innerText = `${pct}%`;
            const leftEl = document.getElementById('dash-budget-left');
            if(leftEl) leftEl.innerText = `Livre: R$ ${(total-spent).toLocaleString('pt-BR')}`;
            const progEl = document.getElementById('dash-progress-bar');
            if(progEl) progEl.style.width = `${pct}%`;

            // Guest Stats Logic (Updated)
            let invitesCount = state.guests.length; // Number of rows/invitations
            let totalPax = 0; // Sum of (1 + partners)
            let guestsConf = 0;

            state.guests.forEach(g => {
                const p = 1 + (parseInt(g.partners)||0);
                // Only count active guests (not declined) for total capacity
                if(g.status !== 'declined') {
                    totalPax += p;
                }
                if(g.status === 'confirmed') guestsConf += p;
            });

            const invEl = document.getElementById('dash-invites-count');
            if(invEl) invEl.innerText = invitesCount;
            const paxEl = document.getElementById('dash-total-pax');
            if(paxEl) paxEl.innerText = totalPax;
            const guestCountEl = document.getElementById('dash-guest-count');
            if(guestCountEl) guestCountEl.innerText = totalPax; // This ID might not be in DOM anymore, but kept for safety
            const confEl = document.getElementById('dash-guest-confirmed');
            if(confEl) confEl.innerText = `${guestsConf} Confirmados`;

            // Update Guests Section Stats if they exist
            const statInvEl = document.getElementById('stats-invites');
            if(statInvEl) statInvEl.innerText = invitesCount;
            const statPaxEl = document.getElementById('stats-total-pax');
            if(statPaxEl) statPaxEl.innerText = totalPax;
            const statConfEl = document.getElementById('stats-confirmed');
            if(statConfEl) statConfEl.innerText = guestsConf;

            renderLists();
            renderCharts(spent, total, state.budget, guestsConf, totalPax);
        }

        function renderLists() {
            // Budget List
            const bl = document.getElementById('budget-list-body');
            bl.innerHTML = '';
            state.budget.forEach(e => {
                bl.innerHTML += `
                    <tr class="hover:bg-emerald-50 border-b border-stone-100 group">
                        <td class="p-3 font-medium text-stone-700">${e.category}</td>
                        <td class="p-3 text-right text-emerald-700 font-bold">R$ ${e.amount.toLocaleString('pt-BR')}</td>
                        <td class="p-3 text-center flex justify-end gap-2">
                            <button onclick="openEditModal('expenses', '${e.id}')" class="text-stone-400 hover:text-blue-500">‚úé</button>
                            <button onclick="deleteExpense('${e.id}')" class="text-stone-300 hover:text-red-500">‚úï</button>
                        </td>
                    </tr>
                `;
            });

            // Guest List (Updated to show calculated Pax Total)
            const gl = document.getElementById('guest-list-body');
            gl.innerHTML = '';
            state.guests.forEach(g => {
                const totalInParty = 1 + (parseInt(g.partners)||0);
                let tags = (g.tags||[]).map(t => `<span class="bg-stone-100 text-stone-500 text-[9px] px-1 rounded border mr-1">${t}</span>`).join('');
                
                gl.innerHTML += `
                    <tr class="hover:bg-emerald-50 border-b border-stone-100">
                        <td class="p-3 font-bold text-stone-700">${g.name}</td>
                        <td class="p-3 text-stone-500 font-mono">${totalInParty} <span class="text-[9px] text-stone-400">(1+${g.partners})</span></td>
                        <td class="p-3">${tags}</td>
                        <td class="p-3">
                            <select onchange="updateGuestStatus('${g.id}', this.value)" class="bg-transparent text-xs font-bold ${g.status==='confirmed'?'text-emerald-600':(g.status==='declined'?'text-red-400':'text-yellow-600')}">
                                <option value="pending" ${g.status==='pending'?'selected':''}>Pendente</option>
                                <option value="confirmed" ${g.status==='confirmed'?'selected':''}>Confirmado</option>
                                <option value="declined" ${g.status==='declined'?'selected':''}>N√£o Vai</option>
                            </select>
                        </td>
                        <td class="p-3 text-right flex justify-end gap-2">
                            <button onclick="openEditModal('guests', '${g.id}')" class="text-stone-400 hover:text-blue-500">‚úé</button>
                            <button onclick="deleteGuest('${g.id}')" class="text-stone-300 hover:text-red-500">‚úï</button>
                        </td>
                    </tr>
                `;
            });

            // Tasks List
            const tl = document.getElementById('tasks-list');
            tl.innerHTML = '';
            state.tasks.forEach(t => {
                const dateTxt = t.deadline ? new Date(t.deadline).toLocaleDateString('pt-BR') : '';
                tl.innerHTML += `
                    <div class="flex items-center justify-between p-3 bg-white border border-stone-100 rounded-lg shadow-sm mb-2">
                        <div class="flex items-center gap-3">
                            <div onclick="toggleTask('${t.id}', ${t.done})" class="w-5 h-5 rounded-full border-2 cursor-pointer flex items-center justify-center ${t.done?'bg-emerald-500 border-emerald-500':'border-stone-300'}">
                                ${t.done ? '<span class="text-white text-[10px]">‚úì</span>' : ''}
                            </div>
                            <div>
                                <p class="text-sm font-bold text-stone-700 ${t.done?'line-through text-stone-400':''}">${t.text}</p>
                                <div class="text-[10px] text-stone-400 font-bold uppercase tracking-wider flex gap-2">
                                    <span>${t.category}</span>
                                    ${dateTxt ? `<span>üìÖ ${dateTxt}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="openEditModal('tasks', '${t.id}')" class="text-stone-400 hover:text-blue-500 text-sm">‚úé</button>
                            <button onclick="deleteTask('${t.id}')" class="text-stone-300 hover:text-red-500 text-sm">‚úï</button>
                        </div>
                    </div>
                `;
            });
        }

        let chart1 = null, chart2 = null;
        function renderCharts(spent, total, items, gConf, gTotal) {
            // Budget
            const ctx1 = document.getElementById('budgetChart');
            if(chart1) chart1.destroy();
            let cats = {}; items.forEach(i => cats[i.category] = (cats[i.category]||0)+i.amount);
            const rem = Math.max(0, total - spent);
            
            chart1 = new Chart(ctx1, {
                type: 'doughnut',
                data: { labels: Object.keys(cats).concat(['Livre']), datasets: [{ data: Object.values(cats).concat([rem]), backgroundColor: ['#059669', '#0891B2', '#D97706', '#DB2777', '#7C3AED', '#E5E7EB'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            document.getElementById('budget-balance-display').innerText = "R$ " + rem.toLocaleString('pt-BR');

            // Guests
            const ctx2 = document.getElementById('guestChart');
            if(chart2) chart2.destroy();
            const pending = gTotal - gConf; 
            chart2 = new Chart(ctx2, {
                type: 'doughnut',
                data: { labels: ['Confirmados', 'Pendentes'], datasets: [{ data: [gConf, pending], backgroundColor: ['#10B981', '#FCD34D'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 8 } } } }
            });
        }

        window.calculateDrinks = () => {
             const guests = parseInt(document.getElementById('calc-guests').value)||0;
            const profile = document.getElementById('calc-profile').value;
            let b=2, w=0.8, s=0.6, sp=0.25;
            if (profile === 'high') { b=4; w=1; s=0.4; } else if (profile === 'low') { b=1.5; sp=0.4; }
            document.getElementById('res-beer').innerText = Math.ceil(guests*b);
            document.getElementById('res-water').innerText = Math.ceil(guests*w);
            document.getElementById('res-soda').innerText = Math.ceil(guests*s);
            document.getElementById('res-sparkling').innerText = Math.ceil(guests*sp);
        }

        window.switchTab = (tabId) => {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            document.querySelectorAll(`button[onclick="switchTab('${tabId}')"]`).forEach(b => b.classList.add('active'));
            if(tabId === 'tools') window.calculateDrinks();
            window.scrollTo(0,0);
        }
    </script>
</body>
</html>
